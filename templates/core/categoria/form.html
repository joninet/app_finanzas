{% extends 'base.html' %}

{% block title %}{{ titulo }} - Finanzas Personales{% endblock %}

{% block page_title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="flex justify-center mb-8">
    <div class="w-full max-w-2xl">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-blue-600 px-6 py-4 border-b border-blue-700">
                <h5 class="text-xl font-bold text-white flex items-center">
                    {% if categoria %}
                    <i class="fas fa-edit mr-2"></i>Editar Categoría
                    {% else %}
                    <i class="fas fa-plus mr-2"></i>Nueva Categoría
                    {% endif %}
                </h5>
            </div>
            <div class="p-6">
                <form method="post" class="space-y-6 needs-validation" novalidate id="categoriaForm">
                    {% csrf_token %}
                    
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="nombre" name="nombre" value="{{ categoria.nombre|default:'' }}" required autofocus>
                        <div class="hidden text-red-500 text-sm mt-1 validation-error">
                            El nombre es obligatorio
                        </div>
                    </div>
                    
                    <div>
                        <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="descripcion" name="descripcion" rows="3">{{ categoria.descripcion|default:'' }}</textarea>
                        <p class="text-gray-500 text-xs mt-1">Opcional: añade detalles sobre esta categoría</p>
                    </div>

                    <!-- Icon Picker -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Icono</label>
                        <input type="hidden" name="icono" id="iconoInput" value="{{ categoria.icono|default:'fa-solid fa-tag' }}">
                        
                        <div class="grid grid-cols-6 sm:grid-cols-8 gap-2 p-2 border border-gray-200 rounded-md bg-gray-50 max-h-48 overflow-y-auto" id="iconGrid">
                            <!-- Icons will be populated by JS or static list -->
                            <!-- Example set of icons -->
                            {% with "fa-tag fa-home fa-wallet fa-money-bill fa-credit-card fa-car fa-plane fa-utensils fa-burger fa-pizza-slice fa-coffee fa-lightbulb fa-bolt fa-water fa-wifi fa-mobile-alt fa-laptop fa-gamepad fa-music fa-book fa-graduation-cap fa-briefcase fa-stethoscope fa-heartbeat fa-dumbbell fa-tshirt fa-shopping-bag fa-shopping-cart fa-gift fa-paw fa-cat fa-dog fa-baby fa-users fa-user fa-building fa-tools fa-wrench fa-broom fa-couch fa-bed fa-bath fa-tree fa-sun fa-moon fa-umbrella fa-bus fa-bicycle fa-train fa-subway fa-taxi" as icon_list %}
                                {% for icon_name in icon_list.split %}
                                    <div class="icon-option cursor-pointer p-2 rounded text-center hover:bg-blue-100 transition-colors {% if categoria and categoria.icono == 'fa-solid ' and icon_name in categoria.icono or not categoria and icon_name == 'fa-tag' %}bg-blue-200 ring-2 ring-blue-500{% endif %}" onclick="selectIcon('fa-solid {{ icon_name }}', this)">
                                        <i class="fa-solid {{ icon_name }} text-xl text-gray-700"></i>
                                    </div>
                                {% endfor %}
                            {% endwith %}
                        </div>
                        <div class="mt-2 flex items-center">
                            <span class="text-sm text-gray-600 mr-2">Seleccionado:</span>
                            <i id="selectedIconPreview" class="{{ categoria.icono|default:'fa-solid fa-tag' }} text-2xl text-blue-600"></i>
                        </div>
                    </div>
                    
                    <div class="flex justify-between pt-4 border-t border-gray-200">
                        <a href="{% url 'categoria_list' %}" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">
                            <i class="fas fa-arrow-left mr-1"></i> Volver
                        </a>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                            <i class="fas fa-save mr-1"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function selectIcon(iconClass, element) {
        document.getElementById('iconoInput').value = iconClass;
        document.getElementById('selectedIconPreview').className = iconClass + ' text-2xl text-blue-600';
        
        // Update visual selection
        document.querySelectorAll('.icon-option').forEach(el => {
            el.classList.remove('bg-blue-200', 'ring-2', 'ring-blue-500');
        });
        element.classList.add('bg-blue-200', 'ring-2', 'ring-blue-500');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar selección visual si existe valor
        const currentIcon = document.getElementById('iconoInput').value;
        if (currentIcon) {
            // Tratar de encontrar el icono en la grilla y marcarlo
            // Esto es aproximado ya que el valor guardado es 'fa-solid fa-xxxx'
            const iconName = currentIcon.replace('fa-solid ', '').trim();
            // Buscar en el DOM
            const options = document.querySelectorAll('.icon-option i');
            options.forEach(icon => {
                if (icon.className.includes(iconName)) {
                    const parent = icon.parentElement;
                    parent.classList.add('bg-blue-200', 'ring-2', 'ring-blue-500');
                }
            });
        }
        
        // Validación de formulario
        const form = document.getElementById('categoriaForm');
        
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                // Mostrar errores manualmente para Tailwind
                const inputs = form.querySelectorAll(':invalid');
                inputs.forEach(input => {
                    input.nextElementSibling.classList.remove('hidden');
                    input.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                });
            }
        });
        
        // Limpiar errores al escribir
        form.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', function() {
                if (this.validity.valid) {
                    this.nextElementSibling?.classList.add('hidden');
                    this.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
                }
            });
        });
    });
</script>
{% endblock %}
